#!/usr/bin/env node

/**
 * Thinkwell CLI launcher
 *
 * This Node.js script detects if Bun is available and delegates to it
 * with the @thinkwell/bun-plugin preloaded.
 */

import { execSync, spawn } from "node:child_process";
import { dirname, resolve } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));

// Check if Bun is available
function isBunAvailable() {
  try {
    execSync("bun --version", { stdio: "ignore" });
    return true;
  } catch {
    return false;
  }
}

// Get the path to the plugin
function getPluginPath() {
  // When installed via npm, the plugin is in our node_modules
  return resolve(__dirname, "../node_modules/@thinkwell/bun-plugin/dist/index.js");
}

// Get the path to the types command script
function getTypesCommandPath() {
  return resolve(__dirname, "../dist/types-command.js");
}

// Parse version from package.json
async function getVersion() {
  const packagePath = resolve(__dirname, "../package.json");
  const { default: pkg } = await import(packagePath, { with: { type: "json" } });
  return pkg.version;
}

// Show help message
function showHelp() {
  console.log(`
thinkwell - Run TypeScript scripts with automatic schema generation

Usage:
  thinkwell <script.ts> [args...]     Run a TypeScript script
  thinkwell run <script.ts> [args...] Explicit run command
  thinkwell types [dir]               Generate .d.ts files for IDE support
  thinkwell types --watch [dir]       Watch and regenerate .d.ts files
  thinkwell --help                    Show this help message
  thinkwell --version                 Show version

Examples:
  thinkwell hello.ts                 Run hello.ts
  thinkwell run hello.ts --verbose   Run with arguments
  ./script.ts                        Via shebang: #!/usr/bin/env thinkwell
  thinkwell types                    Generate declarations in current dir
  thinkwell types src                Generate declarations in src/
  thinkwell types --watch            Watch for changes and regenerate

The thinkwell CLI automatically:
  - Generates JSON Schema for types marked with @JSONSchema
  - Resolves thinkwell:* imports to built-in modules
  - Creates .thinkwell.d.ts files for IDE autocomplete (types command)

For more information, visit: https://github.com/anthropics/thinkwell
`);
}

async function main() {
  const args = process.argv.slice(2);

  // Handle --help
  if (args.includes("--help") || args.includes("-h")) {
    showHelp();
    process.exit(0);
  }

  // Handle --version
  if (args.includes("--version") || args.includes("-v")) {
    const version = await getVersion();
    console.log(`thinkwell ${version}`);
    process.exit(0);
  }

  // Check for Bun
  if (!isBunAvailable()) {
    console.error("Error: Bun is required but not found.");
    console.error("Install it from: https://bun.sh");
    process.exit(1);
  }

  // Handle "types" subcommand
  if (args[0] === "types") {
    const typesArgs = args.slice(1);
    const typesCommandPath = getTypesCommandPath();
    const bunArgs = [typesCommandPath, ...typesArgs];

    const child = spawn("bun", bunArgs, {
      stdio: "inherit",
      env: process.env,
    });

    child.on("error", (err) => {
      console.error(`Failed to start bun: ${err.message}`);
      process.exit(1);
    });

    child.on("exit", (code) => {
      process.exit(code ?? 0);
    });

    return;
  }

  // Handle "run" subcommand - just strip it
  const runArgs = args[0] === "run" ? args.slice(1) : args;

  // If no script provided, show help
  if (runArgs.length === 0) {
    showHelp();
    process.exit(0);
  }

  // Delegate to bun with plugin preloaded
  const pluginPath = getPluginPath();
  const bunArgs = ["--preload", pluginPath, ...runArgs];

  const child = spawn("bun", bunArgs, {
    stdio: "inherit",
    env: process.env,
  });

  child.on("error", (err) => {
    console.error(`Failed to start bun: ${err.message}`);
    process.exit(1);
  });

  child.on("exit", (code) => {
    process.exit(code ?? 0);
  });
}

main();
