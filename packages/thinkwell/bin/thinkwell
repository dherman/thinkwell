#!/usr/bin/env node

/**
 * Thinkwell CLI launcher
 *
 * This Node.js script detects if Bun is available and delegates to it
 * with the @thinkwell/bun-plugin preloaded.
 */

import { execSync, spawn } from "node:child_process";
import { dirname, resolve } from "node:path";
import { fileURLToPath } from "node:url";
import { existsSync } from "node:fs";

const __dirname = dirname(fileURLToPath(import.meta.url));

// Check if Bun is available and return version or null
function getBunVersion() {
  try {
    const version = execSync("bun --version", { encoding: "utf-8" }).trim();
    return version;
  } catch {
    return null;
  }
}

// Get the path to the plugin
function getPluginPath() {
  // When installed via npm, the plugin is in our node_modules
  return resolve(__dirname, "../node_modules/@thinkwell/bun-plugin/dist/index.js");
}

// Get the path to our node_modules (where thinkwell packages are installed)
function getNodeModulesPath() {
  return resolve(__dirname, "../node_modules");
}

// Get the path to the types command script
function getTypesCommandPath() {
  return resolve(__dirname, "../dist/cli/types-command.js");
}

// Validate that required files exist for commands that require Bun
function validateInstallation() {
  const pluginPath = getPluginPath();
  const typesCommandPath = getTypesCommandPath();
  const errors = [];

  if (!existsSync(pluginPath)) {
    errors.push(`Plugin not found: ${pluginPath}`);
  }

  if (!existsSync(typesCommandPath)) {
    errors.push(`Types command not found: ${typesCommandPath}`);
  }

  if (errors.length > 0) {
    console.error("Error: thinkwell installation appears to be corrupted.");
    for (const error of errors) {
      console.error(`  - ${error}`);
    }
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Validate init command is available
function validateInitCommand() {
  const initCommandPath = getInitCommandPath();
  if (!existsSync(initCommandPath)) {
    console.error("Error: thinkwell installation appears to be corrupted.");
    console.error(`  - Init command not found: ${initCommandPath}`);
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Parse version from package.json
async function getVersion() {
  const packagePath = resolve(__dirname, "../package.json");
  const { default: pkg } = await import(packagePath, { with: { type: "json" } });
  return pkg.version;
}

// Get the path to the init command script
function getInitCommandPath() {
  return resolve(__dirname, "../dist/cli/init-command.js");
}

// Show help message
function showHelp() {
  console.log(`
thinkwell - Run TypeScript scripts with automatic schema generation

Usage:
  thinkwell <script.ts> [args...]     Run a TypeScript script
  thinkwell run <script.ts> [args...] Explicit run command
  thinkwell init [project-name]       Initialize a new project
  thinkwell types [dir]               Generate .d.ts files for IDE support
  thinkwell types --watch [dir]       Watch and regenerate .d.ts files
  thinkwell --help                    Show this help message
  thinkwell --version                 Show version

Examples:
  thinkwell hello.ts                 Run hello.ts
  thinkwell run hello.ts --verbose   Run with arguments
  thinkwell init my-agent            Create a new project
  ./script.ts                        Via shebang: #!/usr/bin/env thinkwell
  thinkwell types                    Generate declarations in current dir
  thinkwell types src                Generate declarations in src/
  thinkwell types --watch            Watch for changes and regenerate

The thinkwell CLI automatically:
  - Generates JSON Schema for types marked with @JSONSchema
  - Resolves thinkwell:* imports to built-in modules
  - Creates .thinkwell.d.ts files for IDE autocomplete (types command)

For more information, visit: https://github.com/dherman/thinkwell
`);
}

async function main() {
  const args = process.argv.slice(2);

  // Handle "init" subcommand first - does NOT require Bun
  // Must be before global --help so "init --help" shows init-specific help
  if (args[0] === "init") {
    validateInitCommand();
    const initArgs = args.slice(1);
    const initCommandPath = getInitCommandPath();

    // Import and run the init command
    const { runInit } = await import(initCommandPath);
    await runInit(initArgs);
    process.exit(0);
  }

  // Handle --help (global)
  if (args.includes("--help") || args.includes("-h") || args.length === 0) {
    showHelp();
    process.exit(0);
  }

  // Handle --version
  if (args.includes("--version") || args.includes("-v")) {
    const version = await getVersion();
    console.log(`thinkwell ${version}`);
    process.exit(0);
  }

  // All commands below require Bun
  const bunVersion = getBunVersion();
  if (!bunVersion) {
    console.error("Error: Bun is required to run thinkwell scripts.");
    console.error("");
    console.error("The thinkwell runtime uses Bun for TypeScript execution and schema");
    console.error("generation. This also enables features like compiled executables.");
    console.error("");
    console.error("To install Bun:");
    console.error("  curl -fsSL https://bun.sh/install | bash");
    console.error("");
    console.error("Or via Homebrew:");
    console.error("  brew install oven-sh/bun/bun");
    console.error("");
    console.error("For more information: https://bun.sh");
    process.exit(1);
  }

  // Validate installation
  validateInstallation();

  // Handle "types" subcommand
  if (args[0] === "types") {
    const typesArgs = args.slice(1);
    const typesCommandPath = getTypesCommandPath();
    const bunArgs = [typesCommandPath, ...typesArgs];

    const child = spawn("bun", bunArgs, {
      stdio: "inherit",
      env: process.env,
    });

    child.on("error", (err) => {
      console.error(`Error: Failed to execute 'bun' command.`);
      console.error(`  ${err.message}`);
      if (err.code === "ENOENT") {
        console.error("");
        console.error("Bun was detected but cannot be executed.");
        console.error("Ensure 'bun' is in your PATH and has execute permissions.");
      }
      process.exit(1);
    });

    child.on("exit", (code) => {
      process.exit(code ?? 0);
    });

    return;
  }

  // Handle "run" subcommand - just strip it
  const runArgs = args[0] === "run" ? args.slice(1) : args;

  // If no script provided after "run", show help
  if (runArgs.length === 0) {
    console.error("Error: No script provided.");
    console.error("");
    console.error("Usage: thinkwell run <script.ts> [args...]");
    process.exit(1);
  }

  // Check if the script file exists
  const scriptPath = runArgs[0];
  if (!scriptPath.startsWith("-") && !existsSync(scriptPath)) {
    // Try resolving relative to cwd
    const resolvedPath = resolve(process.cwd(), scriptPath);
    if (!existsSync(resolvedPath)) {
      console.error(`Error: Script not found: ${scriptPath}`);
      console.error("");
      console.error("Make sure the file exists and the path is correct.");
      process.exit(1);
    }
  }

  // Delegate to bun with plugin preloaded
  const pluginPath = getPluginPath();
  const nodeModulesPath = getNodeModulesPath();
  const bunArgs = ["--preload", pluginPath, ...runArgs];

  // Add our node_modules to NODE_PATH so Bun can find thinkwell packages
  // regardless of where the script is located
  const nodePath = process.env.NODE_PATH
    ? `${nodeModulesPath}:${process.env.NODE_PATH}`
    : nodeModulesPath;

  const child = spawn("bun", bunArgs, {
    stdio: "inherit",
    env: { ...process.env, NODE_PATH: nodePath },
  });

  child.on("error", (err) => {
    console.error(`Error: Failed to execute 'bun' command.`);
    console.error(`  ${err.message}`);
    if (err.code === "ENOENT") {
      console.error("");
      console.error("Bun was detected but cannot be executed.");
      console.error("Ensure 'bun' is in your PATH and has execute permissions.");
    }
    process.exit(1);
  });

  child.on("exit", (code) => {
    process.exit(code ?? 0);
  });
}

main();
