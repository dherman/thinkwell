#!/usr/bin/env node

/**
 * Thinkwell CLI launcher
 *
 * This Node.js script serves as the entry point for the npm distribution.
 * It uses Node.js with the pkg-style loader for script execution, requiring
 * Node 24+ for native TypeScript support via --experimental-transform-types.
 *
 * The pkg binary distribution uses a separate entry point (main-pkg.cjs)
 * which is compiled directly into the binary.
 */

import { spawn } from "node:child_process";
import { dirname, resolve, isAbsolute } from "node:path";
import { fileURLToPath } from "node:url";
import { existsSync } from "node:fs";

const __dirname = dirname(fileURLToPath(import.meta.url));

// Minimum Node.js version for native TypeScript support
const MIN_NODE_VERSION = 24;

// ============================================================================
// Path Helpers
// ============================================================================

// Get the path to the init command script
function getInitCommandPath() {
  return resolve(__dirname, "../dist/cli/init-command.js");
}

// Get the path to the types command script
function getTypesCommandPath() {
  return resolve(__dirname, "../dist/cli/types-command.js");
}

// Get the path to the bundled CLI loader
function getLoaderPath() {
  return resolve(__dirname, "../dist-pkg/cli-loader.cjs");
}

// Get paths to the bundled thinkwell packages
function getBundledPackagesPath() {
  return {
    thinkwell: resolve(__dirname, "../dist-pkg/thinkwell.cjs"),
    acp: resolve(__dirname, "../dist-pkg/acp.cjs"),
    protocol: resolve(__dirname, "../dist-pkg/protocol.cjs"),
  };
}

// ============================================================================
// Runtime Detection
// ============================================================================

// Get Node.js major version
function getNodeMajorVersion() {
  const match = process.version.match(/^v(\d+)/);
  return match ? parseInt(match[1], 10) : 0;
}

// ============================================================================
// Validation
// ============================================================================

// Validate Node.js version
function validateNodeVersion() {
  const nodeMajor = getNodeMajorVersion();
  if (nodeMajor < MIN_NODE_VERSION) {
    console.error(`Error: thinkwell requires Node.js ${MIN_NODE_VERSION} or later.`);
    console.error(`Current version: ${process.version}`);
    console.error("");
    console.error("Node.js 24+ is required for native TypeScript support.");
    console.error("Please upgrade Node.js: https://nodejs.org/");
    process.exit(1);
  }
}

// Validate that required files exist for script execution
function validateInstallation() {
  const loaderPath = getLoaderPath();
  const bundledPaths = getBundledPackagesPath();
  const errors = [];

  if (!existsSync(loaderPath)) {
    errors.push(`Loader not found: ${loaderPath}`);
  }

  for (const [name, path] of Object.entries(bundledPaths)) {
    if (!existsSync(path)) {
      errors.push(`Bundled ${name} not found: ${path}`);
    }
  }

  if (errors.length > 0) {
    console.error("Error: thinkwell installation appears to be corrupted.");
    for (const error of errors) {
      console.error(`  - ${error}`);
    }
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Validate init command is available
function validateInitCommand() {
  const initCommandPath = getInitCommandPath();
  if (!existsSync(initCommandPath)) {
    console.error("Error: thinkwell installation appears to be corrupted.");
    console.error(`  - Init command not found: ${initCommandPath}`);
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Validate types command is available
function validateTypesCommand() {
  const typesCommandPath = getTypesCommandPath();
  if (!existsSync(typesCommandPath)) {
    console.error("Error: thinkwell installation appears to be corrupted.");
    console.error(`  - Types command not found: ${typesCommandPath}`);
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Parse version from package.json
async function getVersion() {
  const packagePath = resolve(__dirname, "../package.json");
  const { default: pkg } = await import(packagePath, { with: { type: "json" } });
  return pkg.version;
}

// ============================================================================
// Help
// ============================================================================

function showHelp() {
  console.log(`
thinkwell - Run TypeScript scripts with automatic schema generation

Usage:
  thinkwell <script.ts> [args...]     Run a TypeScript script
  thinkwell run <script.ts> [args...] Explicit run command
  thinkwell init [project-name]       Initialize a new project
  thinkwell types [dir]               Generate .d.ts files for IDE support
  thinkwell types --watch [dir]       Watch and regenerate .d.ts files
  thinkwell --help                    Show this help message
  thinkwell --version                 Show version

Examples:
  thinkwell hello.ts                 Run hello.ts
  thinkwell run hello.ts --verbose   Run with arguments
  thinkwell init my-agent            Create a new project
  ./script.ts                        Via shebang: #!/usr/bin/env thinkwell
  thinkwell types                    Generate declarations in current dir
  thinkwell types src                Generate declarations in src/
  thinkwell types --watch            Watch for changes and regenerate

The thinkwell CLI automatically:
  - Generates JSON Schema for types marked with @JSONSchema
  - Resolves thinkwell:* imports to built-in modules
  - Creates .thinkwell.d.ts files for IDE autocomplete (types command)

For more information, visit: https://github.com/dherman/thinkwell
`);
}

// ============================================================================
// Bundled Module Registration
// ============================================================================

/**
 * Register bundled thinkwell packages to global.__bundled__.
 *
 * For the npm distribution, we load the pre-bundled CJS packages from dist-pkg/.
 * This mirrors what main-pkg.cjs does for the pkg binary distribution.
 */
async function registerBundledModules() {
  const bundledPaths = getBundledPackagesPath();

  try {
    // Dynamic import the bundled CJS packages
    const thinkwell = await import(bundledPaths.thinkwell);
    const acpModule = await import(bundledPaths.acp);
    const protocolModule = await import(bundledPaths.protocol);

    // Register to global.__bundled__ for the loader to access
    global.__bundled__ = {
      thinkwell: thinkwell.default || thinkwell,
      "@thinkwell/acp": acpModule.default || acpModule,
      "@thinkwell/protocol": protocolModule.default || protocolModule,
    };
  } catch (error) {
    console.error("Error: Failed to load bundled modules.");
    console.error("");
    if (process.env.DEBUG) {
      console.error("Debug info:");
      console.error(`  ${error.message}`);
      console.error(error.stack);
    }
    console.error("Try reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// ============================================================================
// Script Execution
// ============================================================================

/**
 * Run a user script using the CLI loader.
 */
async function runUserScript(scriptPath, args) {
  // Resolve the script path
  const resolvedPath = isAbsolute(scriptPath)
    ? scriptPath
    : resolve(process.cwd(), scriptPath);

  // Check if the script file exists
  if (!existsSync(resolvedPath)) {
    console.error(`Error: Script not found: ${scriptPath}`);
    console.error("");
    console.error("Make sure the file exists and the path is correct.");
    process.exit(1);
  }

  // Import the loader
  const loaderPath = getLoaderPath();
  const { runScript } = await import(loaderPath);

  try {
    await runScript(resolvedPath, args);
  } catch (error) {
    // Handle common error cases with helpful messages
    if (error.message && error.message.includes("Cannot find module")) {
      console.error(`Error: ${error.message}`);
      console.error("");
      console.error("Make sure the module is installed in your project's node_modules.");
      process.exit(1);
    }

    if (error.message && error.message.includes("Cannot find package")) {
      console.error(`Error: ${error.message}`);
      console.error("");
      console.error("Run 'npm install' or 'pnpm install' to install dependencies.");
      process.exit(1);
    }

    // Re-throw other errors
    throw error;
  }
}

/**
 * Run the types command.
 *
 * The types command uses the same loader infrastructure to process
 * TypeScript files and generate .d.ts declarations.
 */
async function runTypesCommand(args) {
  validateTypesCommand();
  const typesCommandPath = getTypesCommandPath();

  // Spawn Node.js with the types command
  const child = spawn(process.execPath, [
    "--experimental-transform-types",
    typesCommandPath,
    ...args,
  ], {
    stdio: "inherit",
    env: process.env,
  });

  child.on("error", (err) => {
    console.error(`Error: Failed to run types command.`);
    console.error(`  ${err.message}`);
    process.exit(1);
  });

  child.on("exit", (code) => {
    process.exit(code ?? 0);
  });
}

// ============================================================================
// Main Entry Point
// ============================================================================

async function main() {
  const args = process.argv.slice(2);

  // Handle "init" subcommand first - does NOT require bundled modules
  // Must be before global --help so "init --help" shows init-specific help
  if (args[0] === "init") {
    validateInitCommand();
    const initArgs = args.slice(1);
    const initCommandPath = getInitCommandPath();

    // Import and run the init command
    const { runInit } = await import(initCommandPath);
    await runInit(initArgs);
    process.exit(0);
  }

  // Handle --help (global)
  if (args.includes("--help") || args.includes("-h") || args.length === 0) {
    showHelp();
    process.exit(0);
  }

  // Handle --version
  if (args.includes("--version") || args.includes("-v")) {
    const version = await getVersion();
    console.log(`thinkwell ${version}`);
    process.exit(0);
  }

  // Handle "types" subcommand
  if (args[0] === "types") {
    await runTypesCommand(args.slice(1));
    return;
  }

  // All script execution requires Node 24+ and proper installation
  validateNodeVersion();
  validateInstallation();

  // Handle "run" subcommand - just strip it
  const runArgs = args[0] === "run" ? args.slice(1) : args;

  // If no script provided after "run", show help
  if (runArgs.length === 0) {
    console.error("Error: No script provided.");
    console.error("");
    console.error("Usage: thinkwell <script.ts> [args...]");
    process.exit(1);
  }

  // Register bundled modules before loading user scripts
  await registerBundledModules();

  // Run the user script
  const scriptPath = runArgs[0];
  const scriptArgs = runArgs.slice(1);
  await runUserScript(scriptPath, scriptArgs);
}

main().catch((error) => {
  console.error("Unexpected error:");
  console.error(`  ${error.message || error}`);
  if (process.env.DEBUG) {
    console.error(error.stack);
  }
  process.exit(1);
});
