#!/usr/bin/env node

/**
 * Thinkwell CLI launcher
 *
 * This Node.js script serves as the entry point for the npm distribution.
 * It uses Node.js with the pkg-style loader for script execution, requiring
 * Node 24+ for native TypeScript support via --experimental-transform-types.
 *
 * The pkg binary distribution uses a separate entry point (main.cjs)
 * which is compiled directly into the binary.
 */

import { spawnSync } from "node:child_process";
import { dirname, resolve, isAbsolute } from "node:path";
import { fileURLToPath } from "node:url";
import { existsSync } from "node:fs";

const __dirname = dirname(fileURLToPath(import.meta.url));

// ============================================================================
// Re-exec with Proper Node Flags
// ============================================================================

// Check if we need to re-exec with proper flags
// We use an env var to prevent infinite re-exec loops
const REEXEC_FLAG = "__THINKWELL_REEXEC__";

if (!process.env[REEXEC_FLAG]) {
  // Re-exec with experimental transform types and warning suppression
  const result = spawnSync(process.execPath, [
    "--experimental-transform-types",
    "--disable-warning=ExperimentalWarning",
    fileURLToPath(import.meta.url),
    ...process.argv.slice(2),
  ], {
    stdio: "inherit",
    env: { ...process.env, [REEXEC_FLAG]: "1" },
  });

  process.exit(result.status ?? 1);
}

// Minimum Node.js version for native TypeScript support
const MIN_NODE_VERSION = 24;

// ============================================================================
// Shared Imports (from compiled TypeScript)
// ============================================================================

const commandsPath = resolve(__dirname, "../dist/cli/commands.js");
const { showMainHelp, showNoScriptError, hasHelpFlag, fmtError } = await import(commandsPath);

// ============================================================================
// Path Helpers
// ============================================================================

function getInitCommandPath() {
  return resolve(__dirname, "../dist/cli/init-command.js");
}

function getBuildCommandPath() {
  return resolve(__dirname, "../dist/cli/build.js");
}

function getCheckCommandPath() {
  return resolve(__dirname, "../dist/cli/check.js");
}

function getBundleCommandPath() {
  return resolve(__dirname, "../dist/cli/bundle.js");
}

function getLoaderPath() {
  return resolve(__dirname, "../dist-pkg/cli-loader.cjs");
}

function getBundledPackagesPath() {
  return {
    thinkwell: resolve(__dirname, "../dist-pkg/thinkwell.cjs"),
    acp: resolve(__dirname, "../dist-pkg/acp.cjs"),
    protocol: resolve(__dirname, "../dist-pkg/protocol.cjs"),
  };
}

// ============================================================================
// Runtime Detection
// ============================================================================

function getNodeMajorVersion() {
  const match = process.version.match(/^v(\d+)/);
  return match ? parseInt(match[1], 10) : 0;
}

// ============================================================================
// Validation
// ============================================================================

function validateNodeVersion() {
  const nodeMajor = getNodeMajorVersion();
  if (nodeMajor < MIN_NODE_VERSION) {
    console.error(fmtError(`thinkwell requires Node.js ${MIN_NODE_VERSION} or later.`));
    console.error(`Current version: ${process.version}`);
    console.error("");
    console.error("Node.js 24+ is required for native TypeScript support.");
    console.error("Please upgrade Node.js: https://nodejs.org/");
    process.exit(1);
  }
}

function validateInstallation() {
  const loaderPath = getLoaderPath();
  const bundledPaths = getBundledPackagesPath();
  const errors = [];

  if (!existsSync(loaderPath)) {
    errors.push(`Loader not found: ${loaderPath}`);
  }

  for (const [name, path] of Object.entries(bundledPaths)) {
    if (!existsSync(path)) {
      errors.push(`Bundled ${name} not found: ${path}`);
    }
  }

  if (errors.length > 0) {
    console.error(fmtError("thinkwell installation appears to be corrupted."));
    for (const error of errors) {
      console.error(`  - ${error}`);
    }
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

function validateInitCommand() {
  const initCommandPath = getInitCommandPath();
  if (!existsSync(initCommandPath)) {
    console.error(fmtError("thinkwell installation appears to be corrupted."));
    console.error(`  - Init command not found: ${initCommandPath}`);
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// Parse version from package.json
async function getVersion() {
  const packagePath = resolve(__dirname, "../package.json");
  const { default: pkg } = await import(packagePath, { with: { type: "json" } });
  return pkg.version;
}

// ============================================================================
// Bundled Module Registration
// ============================================================================

/**
 * Register bundled thinkwell packages to global.__bundled__.
 *
 * For the npm distribution, we load the pre-bundled CJS packages from dist-pkg/.
 * This mirrors what main.cjs does for the pkg binary distribution.
 */
async function registerBundledModules() {
  const bundledPaths = getBundledPackagesPath();

  try {
    // Dynamic import the bundled CJS packages
    const thinkwell = await import(bundledPaths.thinkwell);
    const acpModule = await import(bundledPaths.acp);
    const protocolModule = await import(bundledPaths.protocol);

    // Register to global.__bundled__ for the loader to access
    global.__bundled__ = {
      thinkwell: thinkwell.default || thinkwell,
      "@thinkwell/acp": acpModule.default || acpModule,
      "@thinkwell/protocol": protocolModule.default || protocolModule,
    };
  } catch (error) {
    console.error(fmtError("Failed to load bundled modules."));
    console.error("");
    if (process.env.DEBUG) {
      console.error("Debug info:");
      console.error(`  ${error.message}`);
      console.error(error.stack);
    }
    console.error("Try reinstalling with: npm install thinkwell");
    process.exit(1);
  }
}

// ============================================================================
// CLI Commands
// ============================================================================

/**
 * Run the init command to scaffold a new project.
 */
async function runInitCommand(args) {
  validateInitCommand();
  const initCommandPath = getInitCommandPath();
  const { runInit } = await import(initCommandPath);
  await runInit(args);
}

/**
 * Run the build command (tsc-based compilation with @JSONSchema transformation).
 */
async function runBuildCommand(args) {
  const buildCommandPath = getBuildCommandPath();
  const { parseBuildArgs, runBuild, showBuildHelp } = await import(buildCommandPath);

  if (hasHelpFlag(args)) {
    showBuildHelp();
    return;
  }

  try {
    const options = parseBuildArgs(args);
    await runBuild(options);
  } catch (error) {
    console.error(fmtError(error.message));
    process.exit(1);
  }
}

/**
 * Run the check command (type-check with @JSONSchema transformation, no emit).
 */
async function runCheckCommand(args) {
  const checkCommandPath = getCheckCommandPath();
  const { parseCheckArgs, runCheck, showCheckHelp } = await import(checkCommandPath);

  if (hasHelpFlag(args)) {
    showCheckHelp();
    return;
  }

  try {
    const options = parseCheckArgs(args);
    await runCheck(options);
  } catch (error) {
    console.error(fmtError(error.message));
    process.exit(1);
  }
}

/**
 * Run the bundle command to compile scripts into standalone executables.
 */
async function runBundleCommand(args) {
  const bundleCommandPath = getBundleCommandPath();
  if (!existsSync(bundleCommandPath)) {
    console.error(fmtError("thinkwell installation appears to be corrupted."));
    console.error(`  - Bundle command not found: ${bundleCommandPath}`);
    console.error("\nTry reinstalling with: npm install thinkwell");
    process.exit(1);
  }

  const { parseBundleArgs, runBundle, showBundleHelp } = await import(bundleCommandPath);

  if (hasHelpFlag(args)) {
    showBundleHelp();
    return;
  }

  try {
    const options = parseBundleArgs(args);
    await runBundle(options);
  } catch (error) {
    console.error(fmtError(error.message));
    process.exit(1);
  }
}

/**
 * Run a user script using the CLI loader.
 */
async function runUserScript(scriptPath, args) {
  const resolvedPath = isAbsolute(scriptPath)
    ? scriptPath
    : resolve(process.cwd(), scriptPath);

  if (!existsSync(resolvedPath)) {
    console.error(fmtError(`Script not found: ${scriptPath}`));
    console.error("");
    console.error("Make sure the file exists and the path is correct.");
    process.exit(1);
  }

  const loaderPath = getLoaderPath();
  const { runScript } = await import(loaderPath);

  try {
    await runScript(resolvedPath, args);
  } catch (error) {
    if (error.message && error.message.includes("Cannot find module")) {
      console.error(fmtError(error.message));
      console.error("");
      console.error("Make sure the module is installed in your project's node_modules.");
      process.exit(1);
    }

    if (error.message && error.message.includes("Cannot find package")) {
      console.error(fmtError(error.message));
      console.error("");
      console.error("Run 'npm install' or 'pnpm install' to install dependencies.");
      process.exit(1);
    }

    throw error;
  }
}

// ============================================================================
// Main Entry Point
// ============================================================================

async function main() {
  const args = process.argv.slice(2);

  // Handle "init" subcommand - does NOT require bundled modules
  if (args[0] === "init") {
    await runInitCommand(args.slice(1));
    process.exit(0);
  }

  // Handle "bundle" subcommand
  if (args[0] === "bundle") {
    await runBundleCommand(args.slice(1));
    process.exit(0);
  }

  // Handle "build" subcommand — tsc-based build with @JSONSchema transformation
  if (args[0] === "build") {
    await runBuildCommand(args.slice(1));
    process.exit(0);
  }

  // Handle "check" subcommand — type-check with @JSONSchema transformation (no emit)
  if (args[0] === "check") {
    await runCheckCommand(args.slice(1));
    process.exit(0);
  }

  // Handle --help (global) - after subcommand checks
  if (hasHelpFlag(args) || args.length === 0) {
    showMainHelp();
    process.exit(0);
  }

  // Handle --version
  if (args.includes("--version") || args.includes("-v")) {
    const version = await getVersion();
    console.log(`thinkwell ${version}`);
    process.exit(0);
  }

  // All script execution requires Node 24+ and proper installation
  validateNodeVersion();
  validateInstallation();

  // Handle "run" subcommand - just strip it
  const runArgs = args[0] === "run" ? args.slice(1) : args;

  if (runArgs.length === 0) {
    showNoScriptError();
  }

  // Register bundled modules before loading user scripts
  await registerBundledModules();

  // Run the user script
  const scriptPath = runArgs[0];
  const scriptArgs = runArgs.slice(1);
  await runUserScript(scriptPath, scriptArgs);
}

main().catch((error) => {
  console.error(fmtError(`Unexpected error: ${error.message || error}`));
  if (process.env.DEBUG) {
    console.error(error.stack);
  }
  process.exit(1);
});
